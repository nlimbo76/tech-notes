<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>현장운영 on gBear's Tech Notes</title><link>https://nlimbo76.github.io/tech-notes/tags/%ED%98%84%EC%9E%A5%EC%9A%B4%EC%98%81/</link><description>Recent content in 현장운영 on gBear's Tech Notes</description><generator>Hugo -- 0.148.2</generator><language>ko-kr</language><lastBuildDate>Sun, 24 Aug 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://nlimbo76.github.io/tech-notes/tags/%ED%98%84%EC%9E%A5%EC%9A%B4%EC%98%81/index.xml" rel="self" type="application/rss+xml"/><item><title>부트로더 Safe Mode + 리커버리 설계 (정리판)</title><link>https://nlimbo76.github.io/tech-notes/posts/safe-mode-recovery/</link><pubDate>Sun, 24 Aug 2025 00:00:00 +0000</pubDate><guid>https://nlimbo76.github.io/tech-notes/posts/safe-mode-recovery/</guid><description>&lt;h2 id="개요">개요&lt;/h2>
&lt;p>OTA 실패·스토리지 손상·설정 파손 같은 &lt;strong>비정상 부팅 상황&lt;/strong>에서 기기를 벽돌로 만들지 않으려면, **Safe Mode(최소 기능 부팅)**와 &lt;strong>리커버리 경로&lt;/strong>가 필요합니다. 이 문서는 트리거, 부팅 분기, 복구 채널, 보안/신뢰성 전제와 현장 운영 팁을 &lt;strong>적용 중심&lt;/strong>으로 정리합니다.&lt;/p>
&lt;hr>
&lt;h2 id="핵심-개념--설계-포인트">핵심 개념 / 설계 포인트&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>Safe Mode 목표&lt;/strong>: 네트워크 또는 물리 인터페이스를 통한 &lt;strong>재플래시/롤백/설정 초기화&lt;/strong>만 제공.&lt;/li>
&lt;li>&lt;strong>트리거&lt;/strong>: 부팅 연속 실패 횟수, 특정 키 입력/핀 단락, 원격 명령, 펌웨어 플래그(&lt;code>force_safe=1&lt;/code>).&lt;/li>
&lt;li>&lt;strong>부트 분기&lt;/strong>: Normal → Trial(새 이미지 검증) → 실패 시 Safe Mode → 복구/롤백 후 Normal 복귀.&lt;/li>
&lt;li>&lt;strong>복구 채널&lt;/strong>: USB DFU/Mass Storage, UART/XMODEM, SD카드, 이더넷(TFTP/HTTPS), 내부 &lt;strong>Rescue 파티션&lt;/strong>.&lt;/li>
&lt;li>&lt;strong>보안&lt;/strong>: 복구 이미지도 &lt;strong>서명 검증&lt;/strong> 필수. &lt;strong>개발자 모드&lt;/strong>와 현장 모드를 엄격 분리.&lt;/li>
&lt;li>&lt;strong>전원/스토리지 안정성&lt;/strong>: 원자적 플래그 갱신, 저널링/더블버퍼, 배터리/전압 체크 후 플래시 작업.&lt;/li>
&lt;li>&lt;strong>가시성&lt;/strong>: 상태 LED/부저 패턴, 디버그 콘솔 도움말, 오류코드 표준화.&lt;/li>
&lt;li>&lt;strong>현장 운용&lt;/strong>: RMA/AS 절차와 스크립트화, 장치 라벨링(시리얼/버전/키 ID).&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="부트-플로우의사코드">부트 플로우(의사코드)&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">boot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">force_safe&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nf">pin_safe_pressed&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nf">safe_mode&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">trial_mode&lt;/span>&lt;span class="p">()){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">app_health_ok_within&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TIMEBOX&lt;/span>&lt;span class="p">)){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">commit_trial_success&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">boot_app&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">decrement_attempts&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;trial fail -&amp;gt; safe&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">safe_mode&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">reboot&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nf">app_valid&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nf">boot_fail_counter&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">MAX_RETRY&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">safe_mode&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">boot_app&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="safe-mode-구성-요소">Safe Mode 구성 요소&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>Rescue 이미지&lt;/strong>: 읽기 전용(압축 가능), 크기 최소화, 네트워크 스택/스토리지 드라이버/검증 코드 포함.&lt;/li>
&lt;li>&lt;strong>업데이트 명령&lt;/strong>: &lt;code>flash &amp;lt;image.bin&amp;gt; &amp;lt;slot&amp;gt;&lt;/code> / &lt;code>rollback&lt;/code> / &lt;code>factory-reset&lt;/code> / &lt;code>verify &amp;lt;manifest.json&amp;gt;&lt;/code>&lt;/li>
&lt;li>&lt;strong>네트워크&lt;/strong>: DHCP 실패 대비 고정 IP/Link-Local, HTTPS/TLS 기본, 인증 토큰/핀코드.&lt;/li>
&lt;li>&lt;strong>물리 인터페이스&lt;/strong>: DFU 버튼/점퍼, UART 콘솔(속도·명령 최소화), SD 부트(파일명 규약).&lt;/li>
&lt;li>&lt;strong>로그&lt;/strong>: 모든 단계에서 결과/오류코드 기록 → 공유 파티션 업로드 가능.&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="보안-설계">보안 설계&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>서명 없는 리커버리 금지&lt;/strong>: 오프라인 서명/공개키 고정, 만료/철회 목록(CRL 비슷한 메커니즘) 고려.&lt;/li>
&lt;li>&lt;strong>디버그 포트 잠금&lt;/strong>: 생산 모드에선 JTAG/SWD 잠금(또는 보안 디버그 인증).&lt;/li>
&lt;li>&lt;strong>개발자 모드 게이트&lt;/strong>: 하드웨어 키/One-Time Token으로 제한, 디버그 빌드 노출 방지.&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="전원스토리지-안전성">전원/스토리지 안전성&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>원자 플래그&lt;/strong>: 2섹터 토글(상호 배타적 유효 플래그), CRC 포함.&lt;/li>
&lt;li>&lt;strong>더블버퍼 쓰기&lt;/strong>: 새 이미지/메타를 임시 영역에 완성 후 커밋.&lt;/li>
&lt;li>&lt;strong>Wear-level&lt;/strong>: 로그/카운터는 순환 버퍼로 쓰기, NAND는 OOB/ECC 고려.&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="운영-체크리스트">운영 체크리스트&lt;/h2>
&lt;ul>
&lt;li>&lt;input disabled="" type="checkbox"> Safe Mode 진입 트리거 3종 이상(자동/물리/원격).&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> Rescue 이미지의 &lt;strong>서명 검증 경로&lt;/strong> 테스트.&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> 플래그/카운터의 전원 중단 내성 시험(전원 드롭 테스트).&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> LED/콘솔에 &lt;strong>오류코드 매핑표&lt;/strong> 제공.&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> RMA 스크립트와 리커버리 매뉴얼(사진 포함) 배포.&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> 프로비저닝/개발자 모드 잠금 정책 문서화.&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="트러블슈팅-요약">트러블슈팅 요약&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>증상&lt;/th>
&lt;th>원인 후보&lt;/th>
&lt;th>조치&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Safe Mode 반복 진입&lt;/td>
&lt;td>health 신호 타임박스 과도, 스토리지 오류&lt;/td>
&lt;td>타임박스 조정, 스토리지 진단/Bad block 회피&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>리커버리 이미지 거부&lt;/td>
&lt;td>서명/키 ID 불일치&lt;/td>
&lt;td>키 롤오버 정책/manifest 확인&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DFU 중 전원 끊김&lt;/td>
&lt;td>원자 커밋 미비&lt;/td>
&lt;td>더블버퍼/저널링 적용, 진행률 기반 재개&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item></channel></rss>