<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>안전성 on gBear's Tech Notes</title><link>https://nlimbo76.github.io/tech-notes/tags/%EC%95%88%EC%A0%84%EC%84%B1/</link><description>Recent content in 안전성 on gBear's Tech Notes</description><generator>Hugo -- 0.148.2</generator><language>ko-kr</language><lastBuildDate>Sun, 24 Aug 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://nlimbo76.github.io/tech-notes/tags/%EC%95%88%EC%A0%84%EC%84%B1/index.xml" rel="self" type="application/rss+xml"/><item><title>부트로더 A/B + 안전 롤백 설계 (정리판)</title><link>https://nlimbo76.github.io/tech-notes/posts/bootloader-ab-rollback/</link><pubDate>Sun, 24 Aug 2025 00:00:00 +0000</pubDate><guid>https://nlimbo76.github.io/tech-notes/posts/bootloader-ab-rollback/</guid><description>&lt;h2 id="개요">개요&lt;/h2>
&lt;p>현장 기기(게이트웨이, DVR, IoT 센서)에서 &lt;strong>펌웨어 업데이트 실패&lt;/strong>는 곧 장애입니다. 안전성을 높이기 위해 흔히 쓰는 방식이 &lt;strong>A/B 파티션 + 헬스체크 + 자동 롤백&lt;/strong>입니다. 이 글은 설계 핵심과 체크리스트, 최소 구현 스케치를 &lt;strong>정리노트&lt;/strong> 형태로 제공합니다.&lt;/p>
&lt;hr>
&lt;h2 id="1-ab-파티션-핵심">1) A/B 파티션 핵심&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>영역 분리&lt;/strong>: 부트로더, A슬롯(활성), B슬롯(대기), 공유 설정/데이터.&lt;/li>
&lt;li>&lt;strong>원자성&lt;/strong>: 업데이트는 항상 비활성 슬롯(B)에 쓰고, &lt;strong>스위치&lt;/strong>는 부트플래그/부트카운터로 제어.&lt;/li>
&lt;li>&lt;strong>독립성&lt;/strong>: A/B가 서로 다른 버전/파일시스템/레이아웃을 가져도 안전하도록 &lt;strong>부트 인덱스&lt;/strong>만 참조.&lt;/li>
&lt;/ul>
&lt;h3 id="파티션-예">파티션 예&lt;/h3>
&lt;pre tabindex="0">&lt;code>[Boot] [Env] [A: App + FS] [B: App + FS] [Shared NVRAM/Config] [Logs]
&lt;/code>&lt;/pre>&lt;hr>
&lt;h2 id="2-부트-플로우-의사코드">2) 부트 플로우 (의사코드)&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// NVRAM flags
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// boot_slot: 0(A) / 1(B)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// trial: 부팅 검증 중(1) / 정상(0)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// attempts: 남은 재시도 횟수
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">boot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">slot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">get_nv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;boot_slot&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trial&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">get_nv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;trial&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">trial&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nf">health_check_ok&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">decrement_attempts&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">reboot_same_slot&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="nf">switch_slot_and_reboot&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// 롤백
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">set_nv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;trial&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// 검증 완료
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">clear_attempts&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">jump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">slot&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">jump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">slot&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// 정상 부팅
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;strong>핵심&lt;/strong>: 부팅 직후에만 통과시키는 &lt;strong>헬스체크 신호&lt;/strong>(앱이 부트로더에 “정상 가동” 알림). 앱이 정상 기동 전에 크래시/워치독 리셋되면 롤백 로직이 발동.&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="3-헬스체크-설계">3) 헬스체크 설계&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>신호 경로&lt;/strong>: 부트로더가 읽을 수 있는 단 하나의 플래그(NVRAM/EEPROM/FRAM/특정 플래시 섹터).&lt;/li>
&lt;li>&lt;strong>타임박스&lt;/strong>: 예) 전원 인가 후 30초 내 앱이 &lt;code>/dev/flag_ok&lt;/code>에 1 기록 → 부트로더가 다음 부팅에 &lt;code>trial=0&lt;/code>.&lt;/li>
&lt;li>&lt;strong>보수적 판단&lt;/strong>: 플래그가 없으면 실패로 간주(전원 중단, 파일시스템 깨짐 대비).&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="4-ota스위치">4) OTA/스위치&lt;/h2>
&lt;ol>
&lt;li>OTA 클라이언트가 B슬롯에 이미지 다운로드 + 검증(해시/서명).&lt;/li>
&lt;li>&lt;code>boot_slot=B&lt;/code>, &lt;code>trial=1&lt;/code>, &lt;code>attempts=3&lt;/code> 설정 후 &lt;strong>reboot&lt;/strong>.&lt;/li>
&lt;li>앱이 정상 기동 → 헬스체크 통과 → &lt;code>trial=0&lt;/code> 확정.&lt;/li>
&lt;li>실패/재부팅 반복 → attempts 소진 시 자동 롤백.&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>보안&lt;/strong>: 이미지 서명(Ed25519/ECDSA) + 메타데이터(버전/타깃/시간) 무결성 검증을 OTA 단계에서 수행.&lt;/p></description></item></channel></rss>